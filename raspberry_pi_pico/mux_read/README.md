This is the working multiplexer code.
